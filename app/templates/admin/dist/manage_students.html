<!-- templates/admin/manage_students.html -->
{% extends "admin/admin_base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_manage.css') }}">
{% endblock %}

{% block admin_content %}
<div class="manage-users">
    <!-- Display Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
    {% endwith %}

    <div class="contain-head">
        <h2>Manage Students</h2>
        <a href="#" class="btn-add" data-modal="add-student-modal"><i class="fas fa-plus"></i> Add Student</a>
    </div>

    <!-- Search Container -->
    <div class="search-container">
        <form action="{{ url_for('admin.search_students') }}" method="GET" class="search-wrapper">
            <input type="text" id="search-input" name="query" placeholder="Search by name, email, or student number..." value="{{ request.args.get('query', '') }}">
            <button type="submit" id="search-button"><i class="fas fa-search"></i></button>
        </form>   
        
        <div class="search-filters">
            <div class="filter-group">
                <label for="role">Role:</label>
                <select id="role">
                    <option value="all">All Roles</option>
                    <option value="admin">Admin</option>
                    <option value="teacher">Teacher</option>
                    <option value="student">Student</option>
                    <option value="parent">Parent</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="status">Status:</label>
                <select id="status">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            <button id="advanced-search-toggle">Advanced Filters</button>
        </div>
    
        <!-- Advanced Filters Section -->
        <div id="advanced-filters" class="advanced-filters" style="display: none;">
            <div class="filter-group">
                <label for="join-date">Join Date:</label>
                <input type="date" id="join-date">
            </div>
            <div class="filter-group">
                <label for="last-login">Last Login:</label>
                <input type="date" id="last-login">
            </div>
            <div class="filter-group">
                <label for="account-type">Account Type:</label>
                <select id="account-type">
                    <option value="all">All Types</option>
                    <option value="free">Free</option>
                    <option value="premium">Premium</option>
                    <option value="trial">Trial</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="email-verified">Email Verified:</label>
                <select id="email-verified">
                    <option value="all">All</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Table Wrapper for Responsiveness -->
    <div class="table-responsive">
        <!-- Students Table -->
        <!-- templates/admin/manage_students.html -->
<table class="users-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Student Number</th>
            <th>Registration Date</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for student in students %}
        <tr>
            <td>{{ student[0] }}</td> <!-- UserID -->
            <td>{{ student[1] }} {{ student[2] }}</td> <!-- FirstName, LastName -->
            <td>{{ student[3] }}</td> <!-- Email -->
            <td>{{ student[4] }}</td> <!-- StudentNumber -->
            <td>{{ student[5] }}</td> <!-- RegistrationDate -->
            <td>
                <!-- Use UserID for data-student-id -->
                <a href="#" class="btn-edit" data-modal="edit-student-modal" data-student-id="{{ student[0] }}">Edit</a>
                <a href="#" class="btn-delete" data-modal="delete-student-modal" data-student-id="{{ student[0] }}">Delete</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
    </div>

    <!-- Add Student Modal -->
    <div id="add-student-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Add Student</h2>
            <form id="student-form" action="{{ url_for('admin.manage_students') }}" method="POST" class="auth-form">
                <!-- User Fields -->
                <div class="input-group">
                    <input type="text" id="first-name" name="first-name" placeholder=" " required>
                    <label for="first-name">First Name</label>
                </div>
                <div class="input-group">
                    <input type="text" id="last-name" name="last-name" placeholder=" " required>
                    <label for="last-name">Last Name</label>
                </div>
                <div class="input-group">
                    <input type="email" id="email" name="email" placeholder=" " required>
                    <label for="email">Email</label>
                </div>
                <div class="input-group">
                    <input type="text" id="phone" name="phone" placeholder=" " required>
                    <label for="phone">Phone</label>
                </div>
                <div class="input-group">
                    <input type="password" id="password" name="password" placeholder=" " required>
                    <label for="password">Password</label>
                </div>

                <!-- Student Fields -->
                <div class="input-group">
                    <input type="text" id="student-number" name="student-number" placeholder=" " required>
                    <label for="student-number">Student Number</label>
                </div>
                <div class="input-group">
                    <input type="date" id="registration-date" name="registration-date" placeholder=" " required>
                    <label for="registration-date">Registration Date</label>
                </div>
                <div class="input-group">
                    <input type="email" id="parent-email" name="parent-email" placeholder=" ">
                    <label for="parent-email">Link to Parent Email (Optional)</label>
                </div>

                <button type="submit" class="form-button"><i class="fas fa-plus"></i> Add Student</button>
            </form>
        </div>
    </div>

<!-- Edit Student Modal -->
<div id="edit-student-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Edit Student</h2>
        <form id="edit-student-form" action="{{ url_for('admin.edit_student') }}" method="POST" class="auth-form">
            <input type="hidden" id="edit-student-id" name="student_id">
            <div class="input-group">
                <input type="text" id="edit-first-name" name="first-name" placeholder=" " required>
                <label for="edit-first-name">First Name</label>
            </div>
            <div class="input-group">
                <input type="text" id="edit-last-name" name="last-name" placeholder=" " required>
                <label for="edit-last-name">Last Name</label>
            </div>
            <div class="input-group">
                <input type="email" id="edit-email" name="email" placeholder=" " required>
                <label for="edit-email">Email</label>
            </div>
            <div class="input-group">
                <input type="text" id="edit-phone" name="phone" placeholder=" " required>
                <label for="edit-phone">Phone</label>
            </div>
            <div class="input-group">
                <input type="text" id="edit-student-number" name="student-number" placeholder=" " required>
                <label for="edit-student-number">Student Number</label>
            </div>
            <div class="input-group">
                <input type="date" id="edit-registration-date" name="registration-date" placeholder=" " required>
                <label for="edit-registration-date">Registration Date</label>
            </div>
            <div class="input-group">
                <label for="edit-is-active">Account Status:</label> <br> <br>
                <select id="edit-is-active" name="is_active" required style="width: 80%;">
                    <option value="true">Activate</option>
                    <option value="false">Deactivate</option>
                </select>
            </div>
            <button type="submit" class="form-button"><i class="fas fa-save"></i> Save Changes</button>
        </form>
    </div>
</div>

<!-- Delete Student Modal -->
<div id="delete-student-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Delete Student</h2>
        <p>Are you sure you want to delete this student?</p>
        <form id="delete-student-form" action="{{ url_for('admin.delete_student') }}" method="POST">
            <input type="hidden" id="delete-student-id" name="student_id">
            <div class="modal-actions">
                <button type="button" class="btn-cancel">Cancel</button>
                <button type="submit" class="btn-confirm-delete">Delete</button>
            </div>
        </form>
    </div>
</div>

    <!-- Overlay -->
    <div id="overlay"></div>
</div>


<!-- Include the modal.js file -->
<script src="{{ url_for('static', filename='js/modal.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const registrationDateInput = document.getElementById('registration-date');
        const studentForm = document.getElementById('student-form');
        
        // Set max date to today (YYYY-MM-DD format)
        const today = new Date().toISOString().split('T')[0];
        registrationDateInput.setAttribute('max', today);
        
        studentForm.addEventListener('submit', function(e) {
            const selectedDate = new Date(registrationDateInput.value);
            const todayObj = new Date(today);
            
            if (selectedDate > todayObj) {
                e.preventDefault();
                alert('Registration date cannot be in the future!');
                registrationDateInput.focus();
                return false;
            }
            return true;
        });
    });
    </script>

{% endblock %}